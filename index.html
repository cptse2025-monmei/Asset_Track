<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>我的投資儀表板</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
    h1, h2 { color: #2c3e50; }
    .card { background: white; padding: 16px; margin: 16px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input, button, textarea, select { padding: 8px; margin: 4px; font-size: 16px; }
    button { background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    canvas { max-width: 100%; }
    .asset-item { display: flex; gap: 8px; margin: 8px 0; align-items: center; }

    /* ==========================
       頂部價格跑馬燈（右 -> 左）
       ========================== */
    .ticker-bar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.06);
      padding: 10px 12px;
      margin: 0 0 14px 0;
    }
    .ticker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .ticker-title {
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .ticker-subtitle {
      font-weight: 400;
      color: #6b7280;
      font-size: 14px;
    }
    .ticker-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .ticker-actions button {
      background: #111827;
    }
    .ticker-actions button:hover {
      background: #0b1220;
    }
    .ticker-settings {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    .ticker-settings-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .ticker-options {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }
    @media (max-width: 640px) {
      .ticker-options { grid-template-columns: 1fr; }
    }
    .ticker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #111827;
      font-size: 14px;
      user-select: none;
    }
    .ticker-viewport {
      width: 100%;
      overflow: hidden;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(52,152,219,0.10), rgba(155,89,182,0.10));
      border: 1px solid rgba(0,0,0,0.05);
      padding: 10px 0;
    }
    .ticker-track {
      display: flex;
      width: max-content;
      will-change: transform;
      animation: ticker-scroll 26s linear infinite;
    }
    .ticker-viewport:hover .ticker-track {
      animation-play-state: paused;
    }
    .ticker-group {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 0 14px;
      flex-shrink: 0;
    }
    .ticker-item {
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
      white-space: nowrap;
      color: #111827;
      font-size: 15px;
    }
    .ticker-item strong {
      color: #111827;
    }
    .ticker-sep {
      color: rgba(0,0,0,0.35);
    }
    .ticker-delta {
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }
    .ticker-delta.up { color: #0f766e; }
    .ticker-delta.down { color: #b91c1c; }
    .ticker-delta.flat { color: #6b7280; }
    .ticker--static .ticker-track {
      animation: none;
      transform: translateX(0);
    }
    @keyframes ticker-scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }
  </style>
</head>
<body>
  <!-- 頂部價格跑馬燈 -->
  <div class="ticker-bar ticker--static" id="tickerBar">
    <div class="ticker-header">
      <div class="ticker-title">
        即時價格跑馬燈
        <span class="ticker-subtitle">（由右往左移動，滑鼠移上可暫停）</span>
      </div>
      <div class="ticker-actions">
        <button type="button" onclick="toggleTickerSettings()">設定</button>
      </div>
    </div>
    <div class="ticker-viewport">
      <div class="ticker-track" id="tickerTrack">
        <div class="ticker-group" id="tickerGroupA"></div>
        <div class="ticker-group" id="tickerGroupB"></div>
      </div>
    </div>
    <div class="ticker-settings" id="tickerSettings">
      <div class="ticker-settings-row">
        <button type="button" onclick="tickerSelectAll()">全選</button>
        <button type="button" onclick="tickerSelectNone()">全不選</button>
        <button type="button" onclick="refreshTickerPrices()">更新價格</button>
      </div>
      <div class="ticker-options" id="tickerOptions"></div>
      <div class="ticker-settings-row" style="margin-top: 10px;">
        <strong style="color:#111827;">自訂追蹤（不加入投資組合）</strong>
      </div>
      <div class="ticker-settings-row">
        <select id="tickerCustomType" aria-label="自訂類型">
          <option value="stock">股票</option>
          <option value="crypto">加密貨幣</option>
          <option value="commodity">商品</option>
        </select>
        <input type="text" id="tickerCustomSymbol" placeholder="代號（例：AAPL、GC=F、BTC 或 coingecko id）" />
        <input type="text" id="tickerCustomName" placeholder="顯示名稱（可留空）" />
        <button type="button" onclick="addTickerCustomItem()">加入追蹤</button>
      </div>
      <div class="ticker-options" id="tickerCustomOptions"></div>
      <div class="ticker-settings-row" style="margin-top: 10px;">
        <strong style="color:#111827;">報價 API（可選，用於避免 CORS / 代理不穩）</strong>
      </div>
      <div class="ticker-settings-row">
        <input type="text" id="priceApiUrl" placeholder="貼上你的報價 API Base URL（例如 Google Apps Script Web App）" style="flex:1; min-width: 260px;" />
        <button type="button" onclick="savePriceApiSettings()">儲存</button>
      </div>
      <p style="color:#6b7280; margin: 8px 0 0; font-size: 13px;">
        提示：跑馬燈可同時顯示多個標的；選項可來自投資組合或自訂追蹤。加密貨幣若查不到，請改用 CoinGecko 的 coin id（例如 bitcoin、ethereum）。
      </p>
    </div>
  </div>

  <h1>我的投資儀表板</h1>

  <!-- 資產輸入區 -->
  <div class="card">
    <h2>新增/編輯投資標的</h2>
    <div>
      <input type="text" id="assetName" placeholder="資產名稱（如 AAPL、比特幣）" />
      <select id="assetType">
        <option value="stock">股票</option>
        <option value="crypto">加密貨幣</option>
        <option value="commodity">商品（黃金等）</option>
        <option value="cash">現金/其他</option>
      </select>
    </div>
    <div>
      <input type="number" id="assetAmount" placeholder="數量（股數、數量等）" step="any" />
      <input type="text" id="assetSymbol" placeholder="代號（用於查詢價格，如 BTC、GC=F）" />
    </div>
    <button onclick="addAsset()">新增資產</button>
    <button onclick="clearAll()">清除所有資料（僅本機）</button>
  </div>

  <!-- 資產列表與即時價格 -->
  <div class="card">
    <h2>我的投資組合</h2>
    <div id="portfolioList"></div>
    <p><strong>總資產價值（估算）：</strong> <span id="totalValue">NT$ 0</span></p>
    <button onclick="saveSnapshot()">記錄今日總值（用於趨勢圖）</button>
  </div>

  <!-- 資產配置圖 -->
  <div class="card">
    <h2>資產配置比例</h2>
    <canvas id="allocationChart" height="200"></canvas>
  </div>

  <!-- 價值趨勢圖 -->
  <div class="card">
    <h2>投資組合價值趨勢</h2>
    <canvas id="trendChart" height="150"></canvas>
    <p id="trendEmptyMessage" style="display:none; color:#666; margin: 8px 0 0;"></p>
  </div>

  <!-- 投資筆記 -->
  <div class="card">
    <h2>投資筆記</h2>
    <textarea id="note" placeholder="在這裡記錄你的投資想法、策略或提醒..." rows="4" style="width:100%;"></textarea>
    <button onclick="saveNote()">儲存筆記</button>
  </div>

  <script>
    // ==========================
    // 資料結構：所有資料存在 localStorage
    // ==========================
    let portfolio = JSON.parse(localStorage.getItem('portfolio') || '[]');
    let snapshots = JSON.parse(localStorage.getItem('snapshots') || '[]');
    let note = localStorage.getItem('investmentNote') || '';

    // ==========================
    // 跑馬燈：設定與狀態（僅本機 localStorage）
    // ==========================
    const TICKER_SELECTION_KEY = 'tickerSelectionV1';
    const TICKER_PREV_PRICE_KEY = 'tickerPrevPricesV1';
    const TICKER_CUSTOM_ITEMS_KEY = 'tickerCustomItemsV1';
    const PRICE_API_URL_KEY = 'priceApiUrlV1';
    const FX_CACHE_KEY = 'fxCacheV1';
    const TICKER_SUPPORTED_TYPES = new Set(['stock', 'crypto', 'commodity']);
    let pricedPortfolioCacheById = new Map();
    let lastTotalValueTwd = 0;

    function generateAssetId() {
      if (window.crypto?.randomUUID) return crypto.randomUUID();
      return 'a_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
    }

    // 只會補上缺少的 id，不會刪除使用者資料
    function ensureAssetIds() {
      let changed = false;
      portfolio = portfolio.map((a) => {
        if (!a.id) {
          changed = true;
          return { ...a, id: generateAssetId() };
        }
        return a;
      });
      if (changed) savePortfolio();
    }

    function getTickerSelection() {
      try {
        const raw = localStorage.getItem(TICKER_SELECTION_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function setTickerSelection(ids) {
      const safeIds = Array.from(new Set((ids || []).filter(Boolean)));
      localStorage.setItem(TICKER_SELECTION_KEY, JSON.stringify(safeIds));
      renderTickerSettings();
    }

    function toggleTickerSettings() {
      const el = document.getElementById('tickerSettings');
      if (!el) return;
      el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function getPriceApiUrl() {
      return (localStorage.getItem(PRICE_API_URL_KEY) || '').trim();
    }

    function setPriceApiUrl(url) {
      const clean = String(url || '').trim();
      if (clean) localStorage.setItem(PRICE_API_URL_KEY, clean);
      else localStorage.removeItem(PRICE_API_URL_KEY);
    }

    function savePriceApiSettings() {
      const el = document.getElementById('priceApiUrl');
      if (!el) return;
      setPriceApiUrl(el.value);
      alert('已儲存報價 API 設定（重新整理價格後生效）');
      refreshTickerPrices();
      loadPortfolio();
    }

    function tickerSelectAll() {
      const allIds = getTickerCandidates()
        .filter(a => TICKER_SUPPORTED_TYPES.has(a.type))
        .map(a => a.id)
        .filter(Boolean);
      setTickerSelection(allIds);
      refreshTickerPrices();
    }

    function tickerSelectNone() {
      setTickerSelection([]);
      updateTicker([]);
    }

    function renderTickerSettings() {
      const box = document.getElementById('tickerOptions');
      const customBox = document.getElementById('tickerCustomOptions');
      if (!box) return;

      const apiUrlEl = document.getElementById('priceApiUrl');
      if (apiUrlEl) apiUrlEl.value = getPriceApiUrl();

      const selection = new Set(getTickerSelection());
      const candidates = portfolio.filter(a => TICKER_SUPPORTED_TYPES.has(a.type));
      const customItems = getTickerCustomItems().filter(a => TICKER_SUPPORTED_TYPES.has(a.type));

      if (candidates.length === 0) {
        box.innerHTML = '<p style="grid-column: 1 / -1; color:#6b7280; margin:0;">尚無可顯示的標的（請先在下方新增股票/加密貨幣/商品）。</p>';
      } else {
        box.innerHTML = candidates.map((a) => {
          const label = `${a.name}${a.symbol ? ` (${a.symbol})` : ''}`;
          const checked = selection.has(a.id) ? 'checked' : '';
          return `
            <label class="ticker-option">
              <input type="checkbox" data-asset-id="${a.id}" ${checked} />
              <span>${label}</span>
            </label>
          `;
        }).join('');
      }

      box.querySelectorAll('input[type="checkbox"][data-asset-id]').forEach((input) => {
        input.addEventListener('change', () => {
          const id = input.getAttribute('data-asset-id');
          const next = new Set(getTickerSelection());
          if (input.checked) next.add(id);
          else next.delete(id);
          setTickerSelection([...next]);
          refreshTickerPrices();
        });
      });

      if (customBox) {
        if (customItems.length === 0) {
          customBox.innerHTML = '<p style="grid-column: 1 / -1; color:#6b7280; margin:0;">尚未加入任何自訂追蹤。</p>';
        } else {
          customBox.innerHTML = customItems.map((a) => {
            const label = `${a.name || a.symbol}${a.symbol ? ` (${a.symbol})` : ''}`;
            const checked = selection.has(a.id) ? 'checked' : '';
            return `
              <label class="ticker-option" style="justify-content: space-between;">
                <span style="display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" data-custom-id="${a.id}" ${checked} />
                  <span>${label}</span>
                </span>
                <button type="button" data-custom-remove="${a.id}" style="background:#ef4444;">移除</button>
              </label>
            `;
          }).join('');
        }

        customBox.querySelectorAll('input[type="checkbox"][data-custom-id]').forEach((input) => {
          input.addEventListener('change', () => {
            const id = input.getAttribute('data-custom-id');
            const next = new Set(getTickerSelection());
            if (input.checked) next.add(id);
            else next.delete(id);
            setTickerSelection([...next]);
            refreshTickerPrices();
          });
        });

        customBox.querySelectorAll('button[data-custom-remove]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-custom-remove');
            removeTickerCustomItem(id);
          });
        });
      }
    }

    function getPrevPriceMap() {
      try {
        const raw = localStorage.getItem(TICKER_PREV_PRICE_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        return (parsed && typeof parsed === 'object') ? parsed : {};
      } catch {
        return {};
      }
    }

    function setPrevPriceMap(map) {
      try {
        localStorage.setItem(TICKER_PREV_PRICE_KEY, JSON.stringify(map || {}));
      } catch {
        // ignore
      }
    }

    function formatDelta(delta) {
      const sign = delta > 0 ? '+' : '';
      const abs = Math.abs(delta);
      // 盡量避免太長的小數
      const formatted = abs >= 100 ? abs.toFixed(0) : abs.toFixed(2);
      return `${sign}${formatted}`;
    }

    function updateTicker(pricedAssets) {
      const bar = document.getElementById('tickerBar');
      const groupA = document.getElementById('tickerGroupA');
      const groupB = document.getElementById('tickerGroupB');
      if (!bar || !groupA || !groupB) return;

      const selection = new Set(getTickerSelection());
      const candidates = pricedAssets || [];
      const shown = candidates
        .filter(a => selection.has(a.id))
        .filter(a => TICKER_SUPPORTED_TYPES.has(a.type));

      if (shown.length === 0) {
        bar.classList.add('ticker--static');
        const msg = `<span class="ticker-item"><strong>尚未選擇任何標的</strong><span class="ticker-sep">•</span><span style="color:#6b7280;">點「設定」可多選顯示</span></span>`;
        groupA.innerHTML = msg;
        groupB.innerHTML = msg;
        return;
      }

      const prev = getPrevPriceMap();
      const nextPrev = { ...prev };

      const parts = shown.map((a) => {
        const key = a.id;
        const now = Number(a.price) || 0;
        const prevPrice = Number(prev[key]) || 0;
        let deltaHtml = `<span class="ticker-delta flat">—</span>`;
        if (now && prevPrice) {
          const delta = now - prevPrice;
          const cls = delta > 0 ? 'up' : (delta < 0 ? 'down' : 'flat');
          deltaHtml = `<span class="ticker-delta ${cls}">${formatDelta(delta)}</span>`;
        }
        if (now) nextPrev[key] = now;

        const displayName = a.name || a.symbol || '未命名';
        const symbolText = a.symbol ? `(${a.symbol})` : `(${a.type})`;
        const priceText = a.displayPrice || 'N/A';
        return `
          <span class="ticker-item">
            <strong>${displayName}</strong> ${symbolText}
            <span class="ticker-sep">•</span>
            <span>${priceText}</span>
            ${deltaHtml}
          </span>
        `;
      });

      setPrevPriceMap(nextPrev);

      // 如果內容太短也允許滾動；這裡只在有內容時啟用動畫
      bar.classList.remove('ticker--static');
      const html = parts.join('<span class="ticker-sep">｜</span>');
      groupA.innerHTML = html;
      groupB.innerHTML = html;
    }

    // ==========================
    // 初始化
    // ==========================
    document.getElementById('note').value = note;
    ensureAssetIds();
    renderTickerSettings();
    loadPortfolio();

    // 每 2 分鐘更新跑馬燈價格（不會清空投資組合列表畫面）
    setInterval(() => {
      const selection = getTickerSelection();
      if (selection.length > 0) refreshTickerPrices();
    }, 2 * 60 * 1000);

    // ==========================
    // 功能：新增資產
    // ==========================
    function addAsset() {
      const name = document.getElementById('assetName').value.trim();
      const type = document.getElementById('assetType').value;
      const amount = parseFloat(document.getElementById('assetAmount').value);
      const symbol = document.getElementById('assetSymbol').value.trim();

      if (!name || isNaN(amount)) {
        alert('請填寫完整資訊');
        return;
      }

      portfolio.push({ id: generateAssetId(), name, type, amount, symbol, note: '' });
      savePortfolio();
      renderTickerSettings();
      loadPortfolio();
    }

    // ==========================
    // 功能：取得即時價格（共用：列表/跑馬燈）
    // ==========================
    async function getPricedAssets(assets) {
      async function fetchJsonWithFallback(urls) {
        let lastErr = null;
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          } catch (e) {
            lastErr = e;
          }
        }
        throw lastErr || new Error('Fetch failed');
      }

      function normalizeBaseUrl(url) {
        return String(url || '').trim().replace(/\/+$/, '');
      }

      function buildCustomApiUrls(params) {
        const baseUrl = normalizeBaseUrl(getPriceApiUrl());
        if (!baseUrl) return [];
        const qs = new URLSearchParams(params);
        // 允許兩種風格：baseUrl 本身是 endpoint，或 baseUrl + /price
        return [
          `${baseUrl}?${qs.toString()}`,
          `${baseUrl}/price?${qs.toString()}`
        ];
      }

      function inferYahooRegion(symbol) {
        const s = String(symbol || '').toUpperCase();
        // 台股常見後綴：.TW / .TWO
        if (s.endsWith('.TW') || s.endsWith('.TWO')) return 'TW';
        return 'US';
      }

      function buildYahooChartUrls(symbol) {
        const region = inferYahooRegion(symbol);
        const lang = region === 'TW' ? 'zh-TW' : 'en-US';
        const base = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?region=${encodeURIComponent(region)}&lang=${encodeURIComponent(lang)}`;
        // 注意：Yahoo Finance 在瀏覽器端常被 CORS 擋下來，所以提供公開代理作為備援
        // 代理屬第三方服務，若不可用可替換成自架 proxy 或改用 Google Sheet/後端 API
        return [
          base,
          `https://corsproxy.io/?${encodeURIComponent(base)}`,
          `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`
        ];
      }

      function isLikelyCurrencyCode(v) {
        return typeof v === 'string' && /^[A-Z]{3}$/.test(v);
      }

      function formatCurrency(amount, currency) {
        const n = Number(amount);
        if (!Number.isFinite(n)) return 'N/A';
        if (isLikelyCurrencyCode(currency)) {
          try {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency }).format(n);
          } catch {
            // fall through
          }
        }
        return `${currency ? currency + ' ' : ''}${n.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
      }

      function pickLastFinite(arr) {
        if (!Array.isArray(arr)) return 0;
        for (let i = arr.length - 1; i >= 0; i--) {
          const v = Number(arr[i]);
          if (Number.isFinite(v) && v !== 0) return v;
        }
        return 0;
      }

      function getFxCache() {
        try {
          const raw = localStorage.getItem(FX_CACHE_KEY);
          const parsed = raw ? JSON.parse(raw) : null;
          return parsed && typeof parsed === 'object' ? parsed : null;
        } catch {
          return null;
        }
      }

      function setFxCache(cache) {
        try {
          localStorage.setItem(FX_CACHE_KEY, JSON.stringify(cache || {}));
        } catch {
          // ignore
        }
      }

      async function getUsdToTwdRate() {
        const now = Date.now();
        const cache = getFxCache();
        // 快取 6 小時
        if (cache?.usdToTwd && cache?.ts && (now - cache.ts) < 6 * 60 * 60 * 1000) {
          return Number(cache.usdToTwd) || 0;
        }

        // 若有自訂 API，先嘗試使用（可回傳 { rates: { TWD: 31.2 } } 或 { usdToTwd: 31.2 }）
        const customUrls = buildCustomApiUrls({ type: 'fx', base: 'USD' });
        try {
          if (customUrls.length) {
            const data = await fetchJsonWithFallback(customUrls);
            const rate = Number(data?.usdToTwd) || Number(data?.rates?.TWD) || 0;
            if (rate) {
              setFxCache({ ts: now, usdToTwd: rate });
              return rate;
            }
          }
        } catch {
          // ignore, fallback below
        }

        // 公開匯率來源（免 key）
        const res = await fetch(`https://open.er-api.com/v6/latest/USD`);
        const data = await res.json();
        const rate = Number(data?.rates?.TWD) || 0;
        if (rate) setFxCache({ ts: now, usdToTwd: rate });
        return rate;
      }

      const pricePromises = (assets || []).map(async (asset) => {
        let price = 0;
        let displayPrice = 'N/A';
        let currency = '';
        const amount = (asset.type === 'cash')
          ? (Number(asset.amount) || 0)
          : (Number(asset.amount) || 1);

        try {
          if (asset.type === 'crypto') {
            // 使用 CoinGecko（支援比特幣、以太幣等）
            const idMap = {
              'BTC': 'bitcoin',
              'ETH': 'ethereum',
              // 可依需要擴充
            };
            const id = idMap[asset.symbol?.toUpperCase?.()] || (asset.symbol || '').toLowerCase();
            const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=twd`);
            const data = await res.json();
            price = data[id]?.twd || 0;
            currency = 'TWD';
            displayPrice = price ? formatCurrency(price, currency) : 'N/A';
          }
          else if (asset.type === 'commodity' && asset.symbol === 'GOLD') {
            // 免金鑰示範：以固定匯率估算（每公克）
            price = 65000 / 31.1035; // 換算每公克
            currency = 'TWD';
            displayPrice = `${formatCurrency(price, currency)}/公克`;
          }
          else if (asset.type === 'commodity') {
            // 其它商品（例如 GC=F）：優先自訂 API，失敗再用 Yahoo Finance
            let data = null;
            const customUrls = buildCustomApiUrls({ type: 'commodity', symbol: asset.symbol });
            if (customUrls.length) {
              try { data = await fetchJsonWithFallback(customUrls); } catch { data = null; }
            }
            if (data?.price) {
              price = Number(data.price) || 0;
              currency = data.currency || '';
              displayPrice = price ? formatCurrency(price, currency) : 'N/A';
            } else {
              const yahoo = await fetchJsonWithFallback(buildYahooChartUrls(asset.symbol));
              const result = yahoo.chart?.result?.[0];
              currency = result?.meta?.currency || '';
              price = Number(result?.meta?.regularMarketPrice) || pickLastFinite(result?.indicators?.quote?.[0]?.close);
              displayPrice = price ? formatCurrency(price, currency) : 'N/A';
            }
          }
          else if (asset.type === 'stock') {
            // 股票：優先自訂 API，失敗再用 Yahoo Finance
            let data = null;
            const customUrls = buildCustomApiUrls({ type: 'stock', symbol: asset.symbol });
            if (customUrls.length) {
              try { data = await fetchJsonWithFallback(customUrls); } catch { data = null; }
            }
            if (data?.price) {
              price = Number(data.price) || 0;
              currency = data.currency || '';
              displayPrice = price ? formatCurrency(price, currency) : 'N/A';
            } else {
              const yahoo = await fetchJsonWithFallback(buildYahooChartUrls(asset.symbol));
              const result = yahoo.chart?.result?.[0];
              currency = result?.meta?.currency || '';
              // 優先用 regularMarketPrice（更接近即時），沒有就用最後一個非空 close
              price = Number(result?.meta?.regularMarketPrice) || pickLastFinite(result?.indicators?.quote?.[0]?.close);
              displayPrice = price ? formatCurrency(price, currency) : 'N/A';
            }
          }
          else {
            // 現金或其他：使用者手動輸入價值（此處設為 1）
            price = 1;
            currency = 'TWD';
            displayPrice = formatCurrency(amount, currency);
          }
        } catch (e) {
          console.error('取得價格失敗', asset, e);
        }

        const valueNative = asset.type === 'cash' ? amount : (price * amount);
        let valueTwd = valueNative;
        if (currency === 'USD') {
          const usdToTwd = await getUsdToTwdRate();
          if (usdToTwd) valueTwd = valueNative * usdToTwd;
        }
        // 其他幣別目前先不換（可再擴充）
        return { ...asset, price, value: valueTwd, valueNative, displayPrice, currency };
      });

      const updatedAssets = await Promise.all(pricePromises);
      const totalValue = updatedAssets.reduce((sum, a) => sum + (Number(a.value) || 0), 0);
      return { updatedAssets, totalValue };
    }

    // ==========================
    // 功能：載入投資組合並取得即時價格
    // ==========================
    async function loadPortfolio() {
      const listEl = document.getElementById('portfolioList');
      listEl.innerHTML = '<p>正在載入即時價格...</p>';

      if (portfolio.length === 0) {
        listEl.innerHTML = '<p>尚未新增任何投資標的。</p>';
        renderAllocationChart([]);
        pricedPortfolioCacheById = new Map();
        refreshTickerPrices();
        return;
      }

      const { updatedAssets, totalValue } = await getPricedAssets(portfolio);
      pricedPortfolioCacheById = new Map(updatedAssets.map(a => [a.id, a]));
      lastTotalValueTwd = totalValue;

      // 更新畫面
      let html = '';
      updatedAssets.forEach((asset, i) => {
        html += `
          <div class="asset-item">
            <strong>${asset.name}</strong> (${asset.symbol || asset.type})
            <span>數量: ${asset.amount}</span>
            <span>市價: ${asset.displayPrice}</span>
            <span>市值（估算 NT$）: ${new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(asset.value || 0)}</span>
          </div>
        `;
      });
      html += `<p><strong>總資產價值（估算 NT$）：${new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(totalValue || 0)}</strong></p>`;
      listEl.innerHTML = html;
      document.getElementById('totalValue').textContent = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(totalValue || 0);

      // 儲存更新後的組合（含價格快取）
      renderAllocationChart(updatedAssets);
      refreshTickerPrices();
    }

    function getTickerCustomItems() {
      try {
        const raw = localStorage.getItem(TICKER_CUSTOM_ITEMS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function setTickerCustomItems(items) {
      const safe = Array.isArray(items) ? items : [];
      localStorage.setItem(TICKER_CUSTOM_ITEMS_KEY, JSON.stringify(safe));
      renderTickerSettings();
    }

    function getTickerCandidates() {
      const custom = getTickerCustomItems();
      return [...portfolio, ...custom];
    }

    function addTickerCustomItem() {
      const typeEl = document.getElementById('tickerCustomType');
      const symbolEl = document.getElementById('tickerCustomSymbol');
      const nameEl = document.getElementById('tickerCustomName');
      if (!typeEl || !symbolEl || !nameEl) return;

      const type = String(typeEl.value || '').trim();
      const symbol = String(symbolEl.value || '').trim();
      const name = String(nameEl.value || '').trim();

      if (!TICKER_SUPPORTED_TYPES.has(type)) {
        alert('自訂追蹤僅支援：股票/加密貨幣/商品');
        return;
      }
      if (!symbol) {
        alert('請輸入代號');
        return;
      }

      const items = getTickerCustomItems();
      const id = generateAssetId();
      const item = { id, type, symbol, name: name || symbol };
      items.push(item);
      setTickerCustomItems(items);

      // 預設勾選新加入的項目
      const nextSel = new Set(getTickerSelection());
      nextSel.add(id);
      setTickerSelection([...nextSel]);

      symbolEl.value = '';
      nameEl.value = '';
      refreshTickerPrices();
    }

    function removeTickerCustomItem(id) {
      if (!id) return;
      if (!confirm('確定要移除此自訂追蹤項目嗎？')) return;

      const items = getTickerCustomItems().filter(a => a.id !== id);
      setTickerCustomItems(items);

      const nextSel = new Set(getTickerSelection());
      nextSel.delete(id);
      setTickerSelection([...nextSel]);
      refreshTickerPrices();
    }

    // ==========================
    // 功能：只更新跑馬燈價格（不打斷列表顯示）
    // ==========================
    async function refreshTickerPrices() {
      const selection = new Set(getTickerSelection());
      const candidates = getTickerCandidates();
      const selectedAssets = candidates
        .filter(a => selection.has(a.id))
        .filter(a => TICKER_SUPPORTED_TYPES.has(a.type));

      if (selectedAssets.length === 0) {
        updateTicker([]);
        return;
      }

      // 跑馬燈以「最新即時價格」為準：每次刷新都重新抓價
      const { updatedAssets } = await getPricedAssets(selectedAssets);
      updateTicker(updatedAssets);
    }

    // ==========================
    // 功能：繪製資產配置餅圖
    // ==========================
    let allocationChart = null;
    function renderAllocationChart(assets) {
      const ctx = document.getElementById('allocationChart').getContext('2d');
      if (allocationChart) allocationChart.destroy();

      if (assets.length === 0) return;

      const labels = assets.map(a => a.name);
      const data = assets.map(a => a.value);
      const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
      ];

      allocationChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    }

    // ==========================
    // 功能：記錄總值快照（用於趨勢圖）
    // ==========================
    function saveSnapshot() {
      const value = Math.round(Number(lastTotalValueTwd) || 0);
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

      // 避免同一天重複記錄
      const exists = snapshots.some(s => s.date === today);
      if (exists) {
        if (!confirm('今天已記錄過快照，是否覆蓋？')) return;
        snapshots = snapshots.filter(s => s.date !== today);
      }

      snapshots.push({ date: today, value });
      snapshots.sort((a, b) => a.date.localeCompare(b.date));
      localStorage.setItem('snapshots', JSON.stringify(snapshots));
      renderTrendChart();
      alert('已記錄今日總值');
    }

    // ==========================
    // 功能：繪製價值趨勢圖
    // ==========================
    let trendChart = null;
    function renderTrendChart() {
      const canvas = document.getElementById('trendChart');
      const emptyEl = document.getElementById('trendEmptyMessage');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      if (trendChart) trendChart.destroy();

      if (snapshots.length === 0) {
        canvas.style.display = 'none';
        if (emptyEl) {
          emptyEl.textContent = '尚未記錄任何總值快照。';
          emptyEl.style.display = 'block';
        }
        return;
      }

      canvas.style.display = 'block';
      if (emptyEl) emptyEl.style.display = 'none';

      const labels = snapshots.map(s => s.date);
      const data = snapshots.map(s => s.value);

      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '投資組合總值 (NT$)',
            data: data,
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: (value) => 'NT$ ' + value.toLocaleString()
              }
            }
          }
        }
      });
    }

    // 初始化趨勢圖
    renderTrendChart();

    // ==========================
    // 功能：筆記與資料管理
    // ==========================
    function saveNote() {
      const note = document.getElementById('note').value;
      localStorage.setItem('investmentNote', note);
      alert('筆記已儲存');
    }

    function savePortfolio() {
      localStorage.setItem('portfolio', JSON.stringify(portfolio));
    }

    function clearAll() {
      if (confirm('確定要清除所有投資資料、筆記和快照嗎？（此動作無法復原）')) {
        localStorage.removeItem('portfolio');
        localStorage.removeItem('snapshots');
        localStorage.removeItem('investmentNote');
        // 也一併清除跑馬燈顯示偏好（此按鈕本身已要求確認）
        localStorage.removeItem(TICKER_SELECTION_KEY);
        localStorage.removeItem(TICKER_PREV_PRICE_KEY);
        localStorage.removeItem(TICKER_CUSTOM_ITEMS_KEY);
        localStorage.removeItem(PRICE_API_URL_KEY);
        localStorage.removeItem(FX_CACHE_KEY);
        portfolio = [];
        snapshots = [];
        document.getElementById('note').value = '';
        renderTickerSettings();
        loadPortfolio();
        renderTrendChart();
      }
    }

    // 自動每 5 分鐘重新整理價格（可選）
    // setInterval(loadPortfolio, 5 * 60 * 1000);
  </script>
</body>

</html>
